<!DOCTYPE html>
<!--
 Copyright © 2025-2026 Ideas Networks Solutions S.A.,
                       <https://github.com/tapopa>

 This program is free software: you can redistribute it and/or modify it under
 the terms of the GNU Affero General Public License v3.0 as published by the
 Free Software Foundation, either version 3 of the License, or (at your
 option) any later version.

 This program is distributed in the hope that it will be useful, but WITHOUT
 ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License v3.0 for
 more details.

 You should have received a copy of the GNU Affero General Public License v3.0
 along with this program. If not, see
 <https://www.gnu.org/licenses/agpl-3.0.html>.
-->

<head>
  <meta charset="UTF-8" />

  <!-- Fixes the invalid scaling -->
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

  <title>PayPal Top Up</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --border: #e1e5ee;
      --text: #3a3f4b;
      --muted: #8a8f9c;
      --primary: #63B4FF;
      --danger: #F44336;
    }

    @font-face {
      font-family: RobotoGapopa;
      src: url('/assets/assets/fonts/Roboto-Gapopa-Regular.ttf');
    }

    * {
      box-sizing: border-box;
      font-family: RobotoGapopa, Roboto, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: #111;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Modal */
    .constrained {
      width: 420px;
      background: var(--bg);
      padding: 22px;
      position: relative;
    }

    .modal-header {
      text-align: center;
      font-size: 17px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 14px;
    }

    .close-btn {
      position: absolute;
      right: 16px;
      top: 16px;
      font-size: 22px;
      cursor: pointer;
      color: #7d8596;
    }

    .close-btn:hover {
      color: #000;
    }

    .description {
      color: var(--muted);
      font-size: 15px;
      line-height: 1.45;
    }

    .subtitle {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 18px 0;
    }

    .gap-w-3 {
      margin: 0 3px;
    }

    .gap-h-6 {
      margin: 6px 0;
    }

    .gap-h-12 {
      margin: 12px 0;
    }

    /* Divider */
    .divider {
      width: 100%;
      display: flex;
      align-items: center;
      flex-direction: row;
      gap: 14px;
      margin: 18px 0;
      color: #9aa0ad;
      font-size: 14px;
      box-sizing: border-box;
    }

    .divider::before,
    .divider::after {
      content: "";
      flex: 1;
      height: 1px;
      background: #dcdcdc;
    }

    .row {
      display: flex;
      align-items: center;
      margin-top: 8px;
      font-size: 15px;
    }

    .label {
      width: 160px;
      text-align: right;
      color: #888;
      padding-right: 14px;
      flex-shrink: 0;
    }

    .value {
      flex: 1;
      text-align: left;
    }

    .hidden {
      display: none;
    }

    .space-between {
      display: flex;
      align-items: center;
      font-size: 15px;
      justify-content: space-between;
    }

    .split {
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .split-top,
    .split-bottom {
      width: 100vw;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .split-top {
      height: 50vh;
    }

    .split-bottom {
      height: 50vh;
    }

    .scrollable {
      overflow-y: auto;
    }

    .space-between {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
    }

    .centered {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .cover {
      object-fit: cover;
      color: #fff;
      font-size: 128px;
      font-weight: bold;
      text-align: center;
      vertical-align: middle;
      width: 100vw;
      height: 50vh;
      line-height: 50vh;
      object-position: center;
    }

    .cancel-btn {
      background-color: transparent;
      color: var(--danger);
      border: none;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 13px;
      cursor: pointer;
    }

    .text-btn {
      background-color: transparent;
      color: var(--primary);
      border: none;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 13px;
      cursor: pointer;
    }

    .paypal-btn {
      width: min(400px, 90vw);
    }

    .error {
      color: var(--danger);
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div class="close-btn" onclick="closeModal()">×</div>

  <div class="split">
    <div class="split-top cover" id="avatar">
      <img class="cover" />
    </div>

    <!-- Pay. -->
    <div id="view-pay">
      <div class="split-bottom scrollable constrained">
        <div class="modal-header" l10n="label_top_up_by_paypal">Top up by PayPal</div>

        <div class="divider">
          <span>Details</span>
        </div>

        <div class="column">
          <div class="row">
            <span class="label">Account</span>
            <span class="value" id="account"">1111-1111-1111-1111</span>
            </div>

            <div class=" row">
              <span class="label">Top up option</span>
              <span class="value">PayPal</span>
          </div>

          <div class="row">
            <span class="label">To be paid</span>
            <span class="value" id="price">$6.49</span>
          </div>
        </div>

        <div class="gap-h-12"></div>
        <div class="subtitle">To make the payment a secure PayPal page will open.</div>
        <div class="gap-h-12"></div>

        <div id="paypal-btn" class="paypal-btn"></div>

        <div class="gap-h-12"></div>
        <button class="cancel-btn" onclick="closeModal()">Cancel</button>
      </div>
    </div>

    <!-- Processing. -->
    <div id="view-processing" class="hidden">
      <div class="split-bottom space-between constrained">
        <div class="modal-header" l10n="label_top_up_by_paypal">Top up by PayPal</div>

        <div class="centered">
          <div>Transaction is being processed</div>
          <div class="gap-h-6"></div>
          <div class="subtitle">To report any problems contact Support Service and provide your PayPal account e-mail,
            Tapopa ID, Transaction ID.</div>
        </div>

        <button class="text-btn" onclick="closeModal()">Close window</button>
      </div>
    </div>

    <!-- Unfinished. -->
    <div id="view-unfinished" class="hidden">
      <div class="split-bottom space-between constrained">
        <div class="modal-header" l10n="label_top_up_by_paypal">Top up by PayPal</div>

        <div class="centered">
          <div>Transaction unfinished</div>
          <div class="gap-h-6"></div>
          <div class="subtitle">To report any problems contact Support Service and provide your PayPal account e-mail,
            Tapopa ID, Transaction ID.</div>
        </div>

        <button class="text-btn" onclick="closeModal()">Close window</button>
      </div>
    </div>

    <!-- Error. -->
    <div id="view-error" class="hidden">
      <div class="split-bottom space-between constrained">
        <div class="modal-header" l10n="label_top_up_by_paypal">Top up by PayPal</div>

        <div class="centered">
          <div>An error occurred while processing the transaction</div>
          <div class="gap-h-6"></div>
          <div class="error" id="error">Error.</div>
          <div class="gap-h-6"></div>
          <div class="subtitle">To report any problems contact Support Service and provide your PayPal account
            e-mail,
            Tapopa ID, Transaction ID.</div>
        </div>

        <button class="text-btn" onclick="closeModal()">Close window</button>
      </div>
    </div>

  </div>

  <!-- Define the view transition functions -->
  <script>
    function closeModal() {
      window.close();
    }

    function viewPay() {
      document.getElementById('view-pay').classList.remove('hidden');
      document.getElementById('view-processing').classList.add('hidden');
      document.getElementById('view-unfinished').classList.add('hidden');
      document.getElementById('view-error').classList.add('hidden');
    }

    function viewProcessing() {
      document.getElementById('view-pay').classList.add('hidden');
      document.getElementById('view-processing').classList.remove('hidden');
      document.getElementById('view-unfinished').classList.add('hidden');
      document.getElementById('view-error').classList.add('hidden');
    }

    function viewUnfinished() {
      document.getElementById('view-pay').classList.add('hidden');
      document.getElementById('view-processing').classList.add('hidden');
      document.getElementById('view-unfinished').classList.remove('hidden');
      document.getElementById('view-error').classList.add('hidden');
    }

    function viewError(err) {
      document.querySelectorAll('[id=error]').forEach(element => {
        element.innerHTML = `${err}`;
      });

      document.getElementById('view-pay').classList.add('hidden');
      document.getElementById('view-processing').classList.add('hidden');
      document.getElementById('view-unfinished').classList.add('hidden');
      document.getElementById('view-error').classList.remove('hidden');
    }

    // Source - https://stackoverflow.com/a/57401891
    // Posted by supersan
    // Retrieved 2026-02-12, License - CC BY-SA 4.0
    function adjustColor(color, amount) {
      return '#' + color.replace(/^#/, '').replace(/../g, color => ('0' + Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2));
    }
  </script>

  <!-- Initialize localization and translate the page -->
  <script src="/script/fluent.js"></script>
  <script>
    localizePage({
      locales: ['en-US', 'ru-RU', 'es-ES']
    });
  </script>

  <!-- Create and send mutations and queries -->
  <script>
    // `OperationDepositSecret` to use.
    var secret = '';

    // ID of the transaction used for `completeOperationDeposit()` and
    // `declineOperationDeposit()` methods.
    var transactionId = '';

    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function generateRandom(length) {
      const arr = new Uint8Array(length);
      window.crypto.getRandomValues(arr);
      return arr;
    }

    async function createOperationDeposit() {
      try {
        let account = localStorage.getItem('account');
        let credentials = JSON.parse(localStorage.getItem(`credentials_${account}`));

        const urlParams = new URLSearchParams(window.location.search);
        let methodId = urlParams.get('method-id');
        let country = urlParams.get('country');
        let nominal = urlParams.get('nominal').substring(1);
        let id = urlParams.get('id');
        let channel = new BroadcastChannel(id ?? 'channel');

        secret = generateRandom(32).toBase64();

        let endpoint = localStorage.getItem('endpoint');

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'Authorization': `Bearer ${credentials['access']['secret']}`
          },
          body: JSON.stringify({
            query: `
mutation CreateOperationDeposit(
  $methodId: OperationDepositMethodId!
  $nominal: Sum!
  $secret: OperationDepositSecret!
  $country: CountryCode!
) {
  createOperationDeposit(
    methodId: $methodId
    kind: { paypal: { secret: $secret, nominal: $nominal } }
    billingCountry: $country
  ) {
    __typename
    ... on OperationEventsVersioned {
        __typename
      events {
          operation {
            node {
              ... on OperationDeposit {
                id
                num
                status
                processingUrl
              }
            }
          }
        }
      }
    ... on CreateOperationDepositError {
        code
    }
  }
}
      `,
            variables: {
              methodId: methodId,
              secret: secret,
              nominal: nominal,
              country: country,
            },
          })
        });

        if (!response.ok) {
          viewError(`HTTP error. Status is ${response.status}. Data: ${response.data}`);
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        let operation = data['data']['createOperationDeposit']['events'][0]['operation']['node'];

        transactionId = operation.id;
        channel.postMessage({
          'type': 'createOperationDeposit',
          'operationId': transactionId
        });

        console.log(`op -> ${operation}`);

        return operation;
      } catch (error) {
        console.error('Error fetching data:', error);
        viewError(`Unable to fetch data: ${error}`);
      }
    }

    async function completeOperationDeposit() {

      try {
        let endpoint = localStorage.getItem('endpoint');

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          },
          body: JSON.stringify({
            query: `
mutation CompleteOperationDeposit(
  $id: OperationId!
  $secret: OperationDepositSecret
) {
  completeOperationDeposit(
    id: $id
    secret: $secret
  ) {
    __typename
    ... on OperationEventsVersioned {
        __typename
      events {
          operation {
            node {
              status
            }
          }
        }
      }
    ... on CompleteOperationDepositError {
        code
    }
  }
}
      `,
            variables: {
              id: transactionId,
              secret: secret,
            },
          })
        });
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    }

    async function declineOperationDeposit() {
      try {
        let endpoint = localStorage.getItem('endpoint');

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          },
          body: JSON.stringify({
            query: `
mutation DeclineOperationDeposit(
  $id: OperationId!
  $secret: OperationDepositSecret
) {
  declineOperationDeposit(
    id: $id
    secret: $secret
  ) {
    __typename
    ... on OperationEventsVersioned {
        __typename
      events {
          operation {
            node {
              status
            }
          }
        }
      }
    ... on DeclineOperationDepositError {
        code
    }
  }
}
      `,
            variables: {
              id: transactionId,
              secret: secret,
            },
          })
        });
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    }
  </script>

  <!-- Append the PayPal SDK script -->
  <script>
    // Create a `Promise` for resolving the `order - id`.
    let resolve, reject;
    const promise = new Promise((res, rej) => {
      resolve = res;
      reject = rej;
    });

    // Parse the URL query parameters.
    const urlParams = new URLSearchParams(window.location.search);

    // Create the script element.
    const sdk = document.createElement('script');
    let clientId = urlParams.get('client-id');
    sdk.src = `https://www.paypal.com/sdk/js?client-id=${clientId}&currency=HKD&intent=authorize`;
    sdk.type = 'text/javascript';
    sdk.async = true; // Makes the script load without blocking HTML parsing.

    sdk.addEventListener('load', () => {
      console.log('SDK loaded successfully!');

      // Render the PayPal buttons.
      paypal.Buttons({
        createOrder: async (data) => {
          console.log(`createOrder(${data})`);

          let orderId = urlParams.get('order-id');
          if (orderId != null) {
            return orderId;
          }

          let operation = await createOperationDeposit();
          return operation.processingUrl.split('?order_id=')[1];
        },
        onApprove: (data, actions) => {
          console.log(`onApprove(${data})`);
          viewProcessing();
          completeOperationDeposit();
        },
        onCancel: (data) => {
          console.log(`onCancel(${data})`);
          viewUnfinished();
          declineOperationDeposit();
        },
        onError: (err) => {
          console.log(`onError(${err})`);
          viewError(err);
        },
      }).render("#paypal-btn");
    });

    sdk.addEventListener('error', (event) => {
      console.error('Error loading sdk:', event);
      viewError(event);
    });

    document.head.appendChild(sdk);

    document.querySelectorAll('[id=nominal]').forEach(element => {
      element.innerHTML = urlParams.get('nominal');
    });

    document.querySelectorAll('[id=price]').forEach(element => {
      element.innerHTML = urlParams.get('price');
    });

    document.querySelectorAll('[id=account]').forEach(element => {
      element.innerHTML = urlParams.get('account');
    });

    document.querySelectorAll('[id=avatar]').forEach(element => {
      let avatarUrl = localStorage.getItem('avatar');
      if (avatarUrl != null) {
        element.innerHTML = `<img class="cover" src="${avatarUrl}" />`;
      } else {

        let account = urlParams.get('account');

        let sum = 0;
        for (let i = 0; i < account.length; i++) {
          if (account.charAt(i) != '-') {
            sum += account.charCodeAt(i);
          }
        }

        const colors = [
          '#D2B334',
          '#2192FF',
          '#9C27B0',
          '#FF9800',
          '#0094A7',
          '#7F81FF',
          '#FF5722',
          '#C70100',
          '#8BC34A',
          '#16712D',
          '#FF5B89',
          '#332FD0',
          '#B96215',
          '#00BF79',
          '#00ACCF',
          '#ED36FF',
          '#00CC25',
          '#FF1008',
          '#CB9F7A',
        ];

        let color = colors.at(sum % colors.length);
        let lighter = adjustColor(color, 20);

        element.innerHTML = `<div style="background: linear-gradient(${lighter}, ${color}); width: 100%; height: 100%;">${account.substring(0, 2)}</div>`;
      }
    });
  </script>
</body>

</html>