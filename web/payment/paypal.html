<!DOCTYPE html>
<!--
 Copyright Â© 2025-2026 Ideas Networks Solutions S.A.,
                       <https://github.com/tapopa>

 This program is free software: you can redistribute it and/or modify it under
 the terms of the GNU Affero General Public License v3.0 as published by the
 Free Software Foundation, either version 3 of the License, or (at your
 option) any later version.

 This program is distributed in the hope that it will be useful, but WITHOUT
 ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License v3.0 for
 more details.

 You should have received a copy of the GNU Affero General Public License v3.0
 along with this program. If not, see
 <https://www.gnu.org/licenses/agpl-3.0.html>.
-->

<head>
  <meta charset="UTF-8" />

  <!-- Fixes the invalid scaling -->
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

  <title>PayPal Top Up</title>
  <style>
    :root {
      --background: #00000084;
      --bg: #f5f7fb;
      --border: #e1e5ee;
      --text: #3a3f4b;
      --muted: #8a8f9c;
      --primary: #63B4FF;
      --danger: #F44336;
      --white: #fff;
    }

    @font-face {
      font-family: RobotoGapopa;
      src: url('/assets/assets/fonts/Roboto-Gapopa-Regular.ttf');
    }

    * {
      box-sizing: border-box;
      font-family: RobotoGapopa, Roboto, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: var(--background);
    }

    /* Modal */
    .constrained {
      background: var(--bg);
    }

    @media only screen and (max-width: 600px) {
      .constrained {
        border-radius: 0px;
        width: 100vw;
        height: 100vh;
      }
    }

    @media only screen and (min-width: 600px) {
      .constrained {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 436px;
        height: 550px;
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
    }

    .block {
      width: 95%;
      background: var(--white);
      padding: 22px;
      position: relative;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      border: 0.5px solid #ddd;
    }

    @media only screen and (min-width: 600px) {
      .block {
        width: 380px;
      }
    }

    h3 {
      font-size: 17px;
      font-weight: 400;
      padding: 0px;
      margin: 0px;
    }

    .modal-header {
      text-align: center;
      vertical-align: center;
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
      background-color: var(--white);
      width: 100%;
      height: 60px;
      line-height: 60px;
      display: flex;
      align-items: center;
      flex-direction: row;
      justify-content: space-between;
      border: 0.5px solid #ddd;
      box-shadow: 0px 0px 8px 0px rgba(0, 0, 0, 0.2);
    }

    @media only screen and (min-width: 600px) {
      .modal-header {
        border-top-left-radius: 16px;
        border-top-right-radius: 16px;
      }
    }

    .close-btn {
      font-size: 22px;
      cursor: pointer;
      color: #7d8596;
    }

    .close-btn:hover {
      color: #000;
      cursor: pointer;
    }

    .description {
      color: var(--muted);
      font-size: 15px;
      line-height: 1.45;
    }

    .subtitle {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 18px 0;
    }

    .gap-w-3 {
      margin: 0 3px;
    }

    .gap-h-6 {
      margin: 6px 0;
    }

    .gap-h-12 {
      margin: 12px 0;
    }

    /* Divider */
    .divider {
      width: 100%;
      display: flex;
      align-items: center;
      flex-direction: row;
      gap: 14px;
      margin: 18px 0;
      color: #9aa0ad;
      font-size: 14px;
      box-sizing: border-box;
    }

    .divider::before,
    .divider::after {
      content: "";
      flex: 1;
      height: 1px;
      background: #dcdcdc;
    }

    .row {
      display: flex;
      align-items: center;
      margin-top: 8px;
      font-size: 15px;
    }

    .label {
      width: 160px;
      text-align: right;
      color: #888;
      padding-right: 14px;
      flex-shrink: 0;
    }

    .value {
      flex: 1;
      text-align: left;
    }

    .hidden {
      display: none;
    }

    .space-between {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 15px;
      height: calc(100% - 72px);
    }

    .split-top,
    .split-bottom {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .scrollable {
      overflow-y: auto;
    }

    .space-between {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
    }

    .centered {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0px 16px;
    }

    .cover {
      object-fit: cover;
      color: #fff;
      font-size: 128px;
      font-weight: bold;
      text-align: center;
      vertical-align: middle;
      width: 100vw;
      height: 50vh;
      line-height: 50vh;
      object-position: center;
    }

    .cancel-btn {
      background-color: transparent;
      color: var(--danger);
      border: none;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 13px;
      cursor: pointer;
    }

    .text-btn {
      background-color: transparent;
      color: var(--primary);
      border: none;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 13px;
      cursor: pointer;
    }

    .paypal-btn {
      width: min(400px, 90vw);
    }

    .error {
      color: var(--danger);
      font-size: 13px;
    }

    .primary-btn {
      width: 100%;
      height: 48px;
      line-height: 48px;
      text-align: center;
      color: var(--white);
      background-color: var(--primary);
      font-size: 15px;
      border-radius: 12px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <!-- Pay. -->
  <div id="view-pay" class="not-hidden">
    <div class="constrained">
      <div class="modal-header">
        <div style="width: 46px;"></div>
        <span l10n="label_top_up_by_paypal">Top up by PayPal</span>
        <img src="/assets/assets/icons/close_primary.svg" width="16px" height="16px" style="margin-right: 24px;"
          onclick="closeModal()">
      </div>
      <div class="gap-h-6"></div>

      <div class="space-between">
        <div class="block">
          <h3><span l10n="label_details">Details</span></h3>
          <div class="gap-h-6"></div>
          <div class="column">
            <div class="row">
              <span class="label" l10n="label_name">Tap ID</span>
              <span class="value" id="name">Alice</span>
            </div>

            <div class="row">
              <span class="label" l10n="label_num">Tap ID</span>
              <span class="value" id="account"">1111-1111-1111-1111</span>
            </div>

            <div class=" row">
                <span class="label" l10n="label_top_up_option">Top up option</span>
                <span class="value">PayPal</span>
            </div>

            <div class="row">
              <span class="label" l10n="label_to_be_paid">To be paid</span>
              <span class="value" id="price">$6.49</span>
            </div>
          </div>
        </div>

        <div class="centered">
          <div class="gap-h-12"></div>
          <div>Transaction is ready to begin</div>
          <div class="gap-h-6"></div>
          <div class="subtitle">To make the payment a secure PayPal page will open.</div>
          <div class="gap-h-12"></div>
        </div>

        <div>
          <div id="paypal-btn" class="paypal-btn"></div>
          <div class="gap-h-12"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Processing. -->
  <div id="view-processing" class="hidden">
    <div class="constrained">
      <div class="modal-header">
        <div style="width: 46px;"></div>
        <span l10n="label_top_up_by_paypal">Top up by PayPal</span>
        <img src="/assets/assets/icons/close_primary.svg" width="16px" height="16px" style="margin-right: 24px;"
          onclick="closeModal()">
      </div>
      <div class="gap-h-6"></div>

      <div class="space-between">
        <div class="block">
          <h3><span l10n="label_details">Details</span></h3>
          <div class="gap-h-6"></div>
          <div class="column">
            <div class="row">
              <span class="label" l10n="label_name">Tap ID</span>
              <span class="value" id="name">Alice</span>
            </div>

            <div class="row">
              <span class="label" l10n="label_num">Tap ID</span>
              <span class="value" id="account"">1111-1111-1111-1111</span>
            </div>

            <div class=" row">
                <span class="label" l10n="label_top_up_option">Top up option</span>
                <span class="value">PayPal</span>
            </div>

            <div class="row">
              <span class="label" l10n="label_to_be_paid">To be paid</span>
              <span class="value" id="price">$6.49</span>
            </div>
          </div>
        </div>

        <div class="centered">
          <div class="gap-h-12"></div>
          <div l10n="label_transaction_is_being_processed">Transaction is being processed.</div>
          <div class="gap-h-6"></div>
          <div class="subtitle" l10n="label_paypal_in_progress_bottom_description">To report any problems contact
            Support Service and provide your PayPal account
            e-mail,
            Tapopa ID, Transaction ID.</div>
          <div class="gap-h-12"></div>
        </div>

        <div style="width: 100%; padding: 0px 10px;">
          <div class="primary-btn" l10n="btn_close_button" onclick="closeModal()">Close window</div>
          <div class="gap-h-12"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Unfinished. -->
  <div id="view-unfinished" class="hidden">
    <div class="constrained">
      <div class="modal-header">
        <div style="width: 46px;"></div>
        <span l10n="label_top_up_by_paypal">Top up by PayPal</span>
        <img src="/assets/assets/icons/close_primary.svg" width="16px" height="16px" style="margin-right: 24px;"
          onclick="closeModal()">
      </div>
      <div class="gap-h-6"></div>

      <div class="space-between">
        <div class="block">
          <h3><span l10n="label_details">Details</span></h3>
          <div class="gap-h-6"></div>
          <div class="column">
            <div class="row">
              <span class="label" l10n="label_name">Tap ID</span>
              <span class="value" id="name">Alice</span>
            </div>

            <div class="row">
              <span class="label" l10n="label_num">Tap ID</span>
              <span class="value" id="account"">1111-1111-1111-1111</span>
            </div>

            <div class=" row">
                <span class="label" l10n="label_top_up_option">Top up option</span>
                <span class="value">PayPal</span>
            </div>

            <div class="row">
              <span class="label" l10n="label_to_be_paid">To be paid</span>
              <span class="value" id="price">$6.49</span>
            </div>
          </div>
        </div>

        <div class="centered">
          <div class="gap-h-12"></div>
          <div l10n="label_transaction_unfinished">Transaction unfinished.</div>
          <div class="gap-h-6"></div>
          <div class="subtitle" l10n="label_paypal_in_progress_bottom_description">To report any problems contact
            Support Service and provide your PayPal account
            e-mail,
            Tapopa ID, Transaction ID.</div>
          <div class="gap-h-12"></div>
        </div>

        <div style="width: 100%; padding: 0px 10px;">
          <div class="primary-btn" l10n="btn_close_button" onclick="closeModal()">Close window</div>
          <div class="gap-h-12"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error. -->
  <div id="view-error" class="hidden">
    <div class="constrained">
      <div class="modal-header">
        <div style="width: 46px;"></div>
        <span l10n="label_top_up_by_paypal">Top up by PayPal</span>
        <img src="/assets/assets/icons/close_primary.svg" width="16px" height="16px" style="margin-right: 24px;"
          onclick="closeModal()">
      </div>
      <div class="gap-h-6"></div>

      <div class="space-between">
        <div class="block">
          <h3><span l10n="label_details">Details</span></h3>
          <div class="gap-h-6"></div>
          <div class="column">
            <div class="row">
              <span class="label" l10n="label_name">Tap ID</span>
              <span class="value" id="name">Alice</span>
            </div>

            <div class="row">
              <span class="label" l10n="label_num">Tap ID</span>
              <span class="value" id="account"">1111-1111-1111-1111</span>
            </div>

            <div class=" row">
                <span class="label" l10n="label_top_up_option">Top up option</span>
                <span class="value">PayPal</span>
            </div>

            <div class="row">
              <span class="label" l10n="label_to_be_paid">To be paid</span>
              <span class="value" id="price">$6.49</span>
            </div>
          </div>
        </div>

        <div class="centered">
          <div class="gap-h-12"></div>
          <div l10n="label_operation_label_failed">An error occurred while processing the transaction.</div>
          <div class="gap-h-6"></div>
          <div class="error" id="error" l10n="label_error">Error.</div>
          <div class="gap-h-6"></div>
          <div class="subtitle" l10n="label_paypal_in_progress_bottom_description">To report any problems contact
            Support Service and provide your PayPal account
            e-mail,
            Tapopa ID, Transaction ID.</div>
          <div class="gap-h-12"></div>
        </div>

        <div style="width: 100%; padding: 0px 10px;">
          <div class="primary-btn" l10n="btn_close_button" onclick="closeModal()">Close window</div>
          <div class="gap-h-12"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Define the view transition functions -->
  <script>
    function closeModal() {
      window.close();
    }

    function viewPay() {
      document.getElementById('view-pay').classList.remove('hidden');
      document.getElementById('view-processing').classList.add('hidden');
      document.getElementById('view-unfinished').classList.add('hidden');
      document.getElementById('view-error').classList.add('hidden');
    }

    function viewProcessing() {
      document.getElementById('view-pay').classList.add('hidden');
      document.getElementById('view-processing').classList.remove('hidden');
      document.getElementById('view-unfinished').classList.add('hidden');
      document.getElementById('view-error').classList.add('hidden');
    }

    function viewUnfinished() {
      document.getElementById('view-pay').classList.add('hidden');
      document.getElementById('view-processing').classList.add('hidden');
      document.getElementById('view-unfinished').classList.remove('hidden');
      document.getElementById('view-error').classList.add('hidden');
    }

    function viewError(err) {
      document.querySelectorAll('[id=error]').forEach(element => {
        element.innerHTML = `${err}`;
      });

      document.getElementById('view-pay').classList.add('hidden');
      document.getElementById('view-processing').classList.add('hidden');
      document.getElementById('view-unfinished').classList.add('hidden');
      document.getElementById('view-error').classList.remove('hidden');
    }

    // Source - https://stackoverflow.com/a/57401891
    // Posted by supersan
    // Retrieved 2026-02-12, License - CC BY-SA 4.0
    function adjustColor(color, amount) {
      return '#' + color.replace(/^#/, '').replace(/../g, color => ('0' + Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2));
    }
  </script>

  <!-- Initialize localization and translate the page -->
  <script src="/script/fluent.js"></script>
  <script>
    localizePage({
      locales: ['en-US', 'ru-RU', 'es-ES']
    });
  </script>

  <!-- Create and send mutations and queries -->
  <script>
    // `OperationDepositSecret` to use.
    var secret = '';

    // ID of the transaction used for `completeOperationDeposit()` and
    // `declineOperationDeposit()` methods.
    var transactionId = '';

    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function generateRandom(length) {
      const arr = new Uint8Array(length);
      window.crypto.getRandomValues(arr);
      return arr;
    }

    async function createOperationDeposit() {
      try {
        let account = localStorage.getItem('account');
        let credentials = JSON.parse(localStorage.getItem(`credentials_${account}`));

        const urlParams = new URLSearchParams(window.location.search);
        let methodId = urlParams.get('method-id');
        let country = urlParams.get('country');
        let nominal = urlParams.get('nominal').substring(1);
        let id = urlParams.get('id');
        let channel = new BroadcastChannel(id ?? 'channel');

        secret = generateRandom(32).toBase64();

        let endpoint = localStorage.getItem('endpoint');

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'Authorization': `Bearer ${credentials['access']['secret']}`
          },
          body: JSON.stringify({
            query: `
mutation CreateOperationDeposit(
  $methodId: OperationDepositMethodId!
  $nominal: Sum!
  $secret: OperationDepositSecret!
  $country: CountryCode!
) {
  createOperationDeposit(
    methodId: $methodId
    kind: { paypal: { secret: $secret, nominal: $nominal } }
    billingCountry: $country
  ) {
    __typename
    ... on OperationEventsVersioned {
        __typename
      events {
          operation {
            node {
              ... on OperationDeposit {
                id
                num
                status
                processingUrl
              }
            }
          }
        }
      }
    ... on CreateOperationDepositError {
        code
    }
  }
}
      `,
            variables: {
              methodId: methodId,
              secret: secret,
              nominal: nominal,
              country: country,
            },
          })
        });

        if (!response.ok) {
          viewError(`HTTP error. Status is ${response.status}. Data: ${response.data}`);
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        let operation = data['data']['createOperationDeposit']['events'][0]['operation']['node'];

        transactionId = operation.id;
        channel.postMessage({
          'type': 'createOperationDeposit',
          'operationId': transactionId
        });

        console.log(`op -> ${operation}`);

        return operation;
      } catch (error) {
        console.error('Error fetching data:', error);
        viewError(`Unable to fetch data: ${error}`);
      }
    }

    async function completeOperationDeposit() {
      try {
        let endpoint = localStorage.getItem('endpoint') ?? `/api/graphql/v1`;

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          },
          body: JSON.stringify({
            query: `
mutation CompleteOperationDeposit(
  $id: OperationId!
  $secret: OperationDepositSecret
) {
  completeOperationDeposit(
    id: $id
    secret: $secret
  ) {
    __typename
    ... on OperationEventsVersioned {
        __typename
      events {
          operation {
            node {
              status
            }
          }
        }
      }
    ... on CompleteOperationDepositError {
        code
    }
  }
}
      `,
            variables: {
              id: transactionId,
              secret: secret,
            },
          })
        });
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    }

    async function declineOperationDeposit() {
      try {
        let endpoint = localStorage.getItem('endpoint') ?? `/api/graphql/v1`;

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          },
          body: JSON.stringify({
            query: `
mutation DeclineOperationDeposit(
  $id: OperationId!
  $secret: OperationDepositSecret
) {
  declineOperationDeposit(
    id: $id
    secret: $secret
  ) {
    __typename
    ... on OperationEventsVersioned {
        __typename
      events {
          operation {
            node {
              status
            }
          }
        }
      }
    ... on DeclineOperationDepositError {
        code
    }
  }
}
      `,
            variables: {
              id: transactionId,
              secret: secret,
            },
          })
        });
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    }
  </script>

  <!-- Append the PayPal SDK script -->
  <script>
    // Create a `Promise` for resolving the `order - id`.
    let resolve, reject;
    const promise = new Promise((res, rej) => {
      resolve = res;
      reject = rej;
    });

    // Parse the URL query parameters.
    const urlParams = new URLSearchParams(window.location.search);

    secret = urlParams.get('secret') ?? '';
    transactionId = urlParams.get('operation-id') ?? '';

    // Create the script element.
    const sdk = document.createElement('script');
    let clientId = urlParams.get('client-id');
    sdk.src = `https://www.paypal.com/sdk/js?client-id=${clientId}&currency=USD&intent=authorize&disable-funding=card,venmo`;
    sdk.type = 'text/javascript';
    sdk.async = true; // Makes the script load without blocking HTML parsing.

    sdk.addEventListener('load', () => {
      console.log('SDK loaded successfully!');

      // Render the PayPal buttons.
      paypal.Buttons({
        createOrder: async (data) => {
          console.log(`createOrder(${data})`);

          let orderId = urlParams.get('order-id');
          if (orderId != null) {
            return orderId;
          }

          let operation = await createOperationDeposit();
          return operation.processingUrl.split('?order_id=')[1];
        },
        onApprove: (data, actions) => {
          console.log(`onApprove(${data})`);
          viewProcessing();
          completeOperationDeposit();
        },
        onCancel: (data) => {
          console.log(`onCancel(${data})`);
          viewUnfinished();
          declineOperationDeposit();
        },
        onError: (err) => {
          console.log(`onError(${err})`);
          viewError(err);
        },
      }).render("#paypal-btn");
    });

    sdk.addEventListener('error', (event) => {
      console.error('Error loading sdk:', event);
      viewError(event);
    });

    document.head.appendChild(sdk);

    document.querySelectorAll('[id=nominal]').forEach(element => {
      element.innerHTML = urlParams.get('nominal');
    });

    document.querySelectorAll('[id=price]').forEach(element => {
      element.innerHTML = urlParams.get('price');
    });

    document.querySelectorAll('[id=account]').forEach(element => {
      element.innerHTML = urlParams.get('account');
    });

    document.querySelectorAll('[id=name]').forEach(element => {
      element.innerHTML = urlParams.get('name');
    });
  </script>
</body>

</html>